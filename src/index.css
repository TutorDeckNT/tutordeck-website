// Configuration: File types to IGNORE
const IGNORED_TYPES = [
    'image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/bmp', 
    'image/svg+xml', 'video/mp4', 'audio/mpeg'
];

// Configuration: Extensions to IGNORE (fallback if MIME type fails)
const IGNORED_EXTS = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.svg', '.mp4', '.mp3'];

function createUploader() {
    // 1. Check if button already exists to prevent duplicates
    if (document.getElementById('ai-bulk-uploader')) return;

    // 2. Find the AI Studio Input area (The footer area usually contains the prompt box)
    // Note: Class names in Google apps change often, so we look for structural markers.
    const inputArea = document.querySelector('footer') || document.querySelector('textarea')?.closest('div[role="region"]');

    if (!inputArea) return; // UI hasn't loaded yet

    // 3. Create the File Input (Hidden)
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.multiple = true;
    fileInput.webkitdirectory = true; // Allows folder selection
    fileInput.style.display = 'none';

    // 4. Create the UI Button
    const btn = document.createElement('button');
    btn.id = 'ai-bulk-uploader';
    btn.className = 'custom-ai-uploader-btn';
    btn.innerHTML = `
        <svg height="20" viewBox="0 0 24 24" width="20"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
        Load Code/Text
    `;

    // 5. Handle File Selection
    btn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', async (e) => {
        const rawFiles = Array.from(e.target.files);
        
        // FILTER: Remove images and non-text/code files
        const validFiles = rawFiles.filter(file => {
            const isImageMime = IGNORED_TYPES.some(type => file.type.includes(type));
            const isImageExt = IGNORED_EXTS.some(ext => file.name.toLowerCase().endsWith(ext));
            return !isImageMime && !isImageExt;
        });

        if (validFiles.length === 0) {
            alert("No valid non-image files found in selection.");
            return;
        }

        console.log(`Uploading ${validFiles.length} files...`);
        
        // 6. Trigger the Drop Event into AI Studio
        uploadFilesToAiStudio(validFiles);
    });

    // 7. Inject the button
    // We try to place it before the text area wrapper
    const container = inputArea.parentElement || inputArea;
    container.insertBefore(btn, container.firstChild);
    container.appendChild(fileInput);
}

function uploadFilesToAiStudio(files) {
    // Find the drop target. Usually the window or the main text area accepts drops.
    const dropTarget = document.querySelector('textarea') || document.body;

    // Create a DataTransfer object (standard browser API for drag/drop)
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));

    // Dispatch events to simulate a user dragging and dropping files
    const events = ['dragenter', 'dragover', 'drop'];

    events.forEach(eventType => {
        const event = new DragEvent(eventType, {
            bubbles: true,
            cancelable: true,
            dataTransfer: dataTransfer
        });
        dropTarget.dispatchEvent(event);
    });

    // Optional: Visual feedback
    const btn = document.getElementById('ai-bulk-uploader');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'âœ… Uploaded!';
    setTimeout(() => btn.innerHTML = originalText, 2000);
}

// 8. Observer: Keep watching the DOM because AI Studio is a Single Page App (SPA)
// If you navigate away and back, the button needs to be re-added.
const observer = new MutationObserver(() => {
    createUploader();
});

observer.observe(document.body, { childList: true, subtree: true });

// Initial run
setTimeout(createUploader, 1500);
